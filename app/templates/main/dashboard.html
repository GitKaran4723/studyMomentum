{% extends "base.html" %}

{% block title %}Dashboard - Study Momentum{% endblock %}

{% block content %}
<!-- Modern Hero Section with Gradient -->
<div class="bg-gradient-to-br from-blue-600 via-purple-600 to-blue-800 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16">
        <div class="lg:grid lg:grid-cols-2 lg:gap-8 items-center">
            <!-- Hero Content -->
            <div class="space-y-6">
                <!-- Greeting Badge -->
                <div class="inline-flex items-center px-4 py-2 bg-white/20 backdrop-blur-sm rounded-full text-sm font-medium">
                    <i class="material-icons text-lg mr-2">wb_sunny</i>
                    <span>Good {% if now().hour < 12 %}morning{% elif now().hour < 18 %}afternoon{% else %}evening{% endif %}</span>
                </div>
                
                <!-- Main Title -->
                <div>
                    <h1 class="text-4xl lg:text-5xl font-bold leading-tight">
                        Ready to achieve 
                        <span class="bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent">greatness</span>?
                    </h1>
                    <p class="mt-4 text-lg lg:text-xl text-blue-100 leading-relaxed">
                        Your personal command center for tracking progress, completing tasks, and reaching ambitious goals.
                    </p>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4">
                    <a href="{{ url_for('main.new_task') }}" 
                       class="inline-flex items-center justify-center px-6 py-3 bg-white text-blue-600 font-semibold rounded-lg hover:bg-blue-50 transition-colors shadow-lg">
                        <i class="material-icons mr-2">add_task</i>
                        Add New Task
                    </a>
                    <a href="{{ url_for('main.new_goal') }}" 
                       class="inline-flex items-center justify-center px-6 py-3 bg-transparent border-2 border-white text-white font-semibold rounded-lg hover:bg-white/10 transition-colors">
                        <i class="material-icons mr-2">flag</i>
                        Set New Goal
                    </a>
                </div>
            </div>
            
            <!-- Quick Stats Cards -->
            <div class="mt-12 lg:mt-0 space-y-4">
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                <i class="material-icons text-blue-200 text-2xl">assignment</i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold">{{ today_total }}</div>
                            <div class="text-blue-200">Today's Tasks</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-green-500/20 rounded-lg flex items-center justify-center">
                                <i class="material-icons text-green-200 text-2xl">check_circle</i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold">{{ today_completed }}</div>
                            <div class="text-blue-200">Completed</div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-yellow-500/20 rounded-lg flex items-center justify-center">
                                <i class="material-icons text-yellow-200 text-2xl">grade</i>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="text-2xl font-bold">{{ "%.1f"|format(today_score) }}</div>
                            <div class="text-blue-200">Quality Score</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Dashboard -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Live Time Progress Bar (3 AM - 9 PM IST) - FUTURISTIC DESIGN -->
    <div class="mb-8" x-data="timeProgress()" x-init="startClock()">
        <div class="relative rounded-2xl overflow-hidden shadow-2xl">
            <!-- Animated Gradient Background -->
            <div class="absolute inset-0 bg-gradient-to-br from-indigo-900 via-purple-900 to-pink-900"></div>
            
            <!-- Animated Particles Effect -->
            <div class="absolute inset-0 opacity-30">
                <div class="absolute w-full h-full animate-pulse bg-gradient-to-r from-transparent via-white to-transparent"></div>
            </div>
            
            <!-- Glowing Border -->
            <div class="absolute inset-0 border-2 border-purple-400 rounded-2xl animate-pulse"></div>
            
            <!-- Content Container -->
            <div class="relative z-10 p-4 sm:p-6 lg:p-8">
                <!-- Top Section: Header & Clock -->
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                    <!-- Title Section -->
                    <div class="flex items-center gap-3 flex-1">
                        <div class="relative">
                            <div class="w-14 h-14 rounded-full bg-gradient-to-br from-yellow-400 to-red-500 flex items-center justify-center shadow-lg">
                                <i class="material-icons text-3xl text-white animate-pulse">schedule</i>
                            </div>
                            <div class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full animate-ping"></div>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-xl sm:text-2xl lg:text-3xl font-bold text-white mb-1 tracking-tight">
                                ‚è∞ Time is Ticking Away!
                            </h3>
                            <p class="text-purple-200 text-xs sm:text-sm font-medium" x-text="motivationalMessage">Loading...</p>
                        </div>
                    </div>
                    
                    <!-- Digital Clock -->
                    <div class="bg-black/40 backdrop-blur-xl rounded-xl px-4 sm:px-6 py-3 border border-purple-400/30 shadow-xl">
                        <div class="text-3xl sm:text-4xl lg:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-blue-400 to-purple-400 tracking-wider font-mono" 
                             x-text="currentTime">00:00:00</div>
                        <div class="text-xs sm:text-sm text-purple-300 text-center mt-1 font-semibold">IST</div>
                    </div>
                </div>
                
                <!-- Progress Bar Section -->
                <div class="mb-6">
                    <!-- Progress Header -->
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2">
                            <span class="text-xs sm:text-sm font-bold text-green-300">3:00 AM</span>
                            <div class="hidden sm:block w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                        </div>
                        <div class="flex items-center gap-2 bg-black/40 px-3 sm:px-4 py-1.5 rounded-full border border-purple-400/30">
                            <i class="material-icons text-yellow-400 text-sm sm:text-base animate-pulse">trending_up</i>
                            <span class="text-lg sm:text-xl lg:text-2xl font-bold text-white" x-text="timePercentage + '%'">0%</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="hidden sm:block w-2 h-2 rounded-full bg-red-400 animate-pulse"></div>
                            <span class="text-xs sm:text-sm font-bold text-red-300">9:00 PM</span>
                        </div>
                    </div>
                    
                    <!-- Futuristic Progress Bar -->
                    <div class="relative">
                        <!-- Outer Glow -->
                        <div class="absolute -inset-1 bg-gradient-to-r from-purple-600 to-pink-600 rounded-full blur opacity-50"></div>
                        
                        <!-- Progress Bar Container -->
                        <div class="relative w-full h-8 sm:h-10 bg-black/60 backdrop-blur-sm rounded-full border-2 border-purple-400/40 overflow-hidden shadow-inner">
                            <!-- Progress Fill with Gradient -->
                            <div class="h-full rounded-full transition-all duration-1000 ease-out relative overflow-hidden"
                                 :style="`width: ${timePercentage}%; background: linear-gradient(90deg, #10b981 0%, #3b82f6 30%, #f59e0b 60%, #ef4444 100%);`">
                                <!-- Shimmer Effect -->
                                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-pulse"></div>
                                
                                <!-- Fire Icon at Progress End -->
                                <div class="absolute right-2 top-1/2 -translate-y-1/2 flex items-center gap-1">
                                    <i class="material-icons text-white text-xl sm:text-2xl drop-shadow-lg animate-bounce">local_fire_department</i>
                                </div>
                            </div>
                            
                            <!-- Progress Markers -->
                            <div class="absolute inset-0 flex justify-around items-center px-2">
                                <div class="w-px h-4 bg-white/20"></div>
                                <div class="w-px h-4 bg-white/20"></div>
                                <div class="w-px h-4 bg-white/20"></div>
                            </div>
                        </div>
                        
                        <!-- Time Markers Below -->
                        <div class="flex justify-around mt-2 text-xs text-purple-300 font-medium">
                            <span class="opacity-60">6 AM</span>
                            <span class="opacity-80">12 PM</span>
                            <span class="opacity-60">6 PM</span>
                        </div>
                    </div>
                </div>
                
                <!-- Urgency Alert Box -->
                <div class="bg-gradient-to-r from-orange-500/20 to-red-500/20 backdrop-blur-md rounded-xl p-4 sm:p-5 border border-orange-400/30 mb-5 shadow-lg">
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 flex items-center justify-center shadow-lg">
                                <i class="material-icons text-white text-xl sm:text-2xl animate-bounce">bolt</i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="text-base sm:text-lg lg:text-xl font-bold text-white mb-1.5" x-text="urgencyTitle">Loading...</h4>
                            <p class="text-xs sm:text-sm text-purple-100 leading-relaxed" x-text="urgencyMessage">Loading message...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Grid - Futuristic Cards -->
                <div class="grid grid-cols-3 gap-3 sm:gap-4 lg:gap-6">
                    <!-- Hours Left -->
                    <div class="group relative">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl blur opacity-30 group-hover:opacity-60 transition"></div>
                        <div class="relative bg-black/60 backdrop-blur-xl rounded-xl p-3 sm:p-4 lg:p-5 border border-green-400/30 text-center hover:scale-105 transition-transform">
                            <div class="text-2xl sm:text-3xl lg:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-br from-green-300 to-emerald-400 mb-1" 
                                 x-text="hoursLeft">0</div>
                            <div class="text-xs sm:text-sm text-green-300 font-semibold">Hours Left</div>
                            <i class="material-icons text-green-400/30 text-3xl sm:text-4xl absolute top-1 right-1 opacity-20">schedule</i>
                        </div>
                    </div>
                    
                    <!-- Minutes Left -->
                    <div class="group relative">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-cyan-600 rounded-xl blur opacity-30 group-hover:opacity-60 transition"></div>
                        <div class="relative bg-black/60 backdrop-blur-xl rounded-xl p-3 sm:p-4 lg:p-5 border border-blue-400/30 text-center hover:scale-105 transition-transform">
                            <div class="text-2xl sm:text-3xl lg:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-br from-blue-300 to-cyan-400 mb-1" 
                                 x-text="minutesLeft">0</div>
                            <div class="text-xs sm:text-sm text-blue-300 font-semibold">Minutes Left</div>
                            <i class="material-icons text-blue-400/30 text-3xl sm:text-4xl absolute top-1 right-1 opacity-20">av_timer</i>
                        </div>
                    </div>
                    
                    <!-- Status -->
                    <div class="group relative">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-purple-500 to-pink-600 rounded-xl blur opacity-30 group-hover:opacity-60 transition"></div>
                        <div class="relative bg-black/60 backdrop-blur-xl rounded-xl p-3 sm:p-4 lg:p-5 border border-purple-400/30 text-center hover:scale-105 transition-transform">
                            <div class="text-3xl sm:text-4xl lg:text-5xl mb-1" x-text="timeStatus">üî•</div>
                            <div class="text-xs sm:text-sm text-purple-300 font-semibold">Status</div>
                            <i class="material-icons text-purple-400/30 text-3xl sm:text-4xl absolute top-1 right-1 opacity-20">star</i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overdue/Pending Alert Section -->
    {% if overdue_count > 0 %}
    <div class="mb-8 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl shadow-lg p-6 border-2 border-orange-400">
        <div class="flex items-start justify-between">
            <div class="flex items-start space-x-4">
                <div class="flex-shrink-0">
                    <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center">
                        <i class="material-icons text-2xl">warning</i>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-2">‚ö†Ô∏è {{ overdue_count }} Pending Task{{ 's' if overdue_count != 1 else '' }}</h3>
                    <p class="text-orange-100 mb-4">You have unfinished tasks from previous days. Let's clear the backlog!</p>
                    
                    <!-- Collapsible Overdue Tasks -->
                    <div x-data="{ showOverdue: false }" class="mt-4">
                        <button @click="showOverdue = !showOverdue" 
                                class="inline-flex items-center px-4 py-2 bg-white/20 hover:bg-white/30 backdrop-blur-sm rounded-lg font-medium transition-colors">
                            <span x-text="showOverdue ? 'Hide Pending Tasks' : 'Show Pending Tasks'"></span>
                            <i class="material-icons ml-2 transition-transform duration-200" :class="showOverdue ? 'rotate-180' : ''">expand_more</i>
                        </button>
                        
                        <div x-show="showOverdue" x-collapse class="mt-4 space-y-3">
                            {% for task in overdue_tasks %}
                            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 border border-white/20">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <span class="px-2 py-1 bg-red-500/30 rounded text-xs font-medium">
                                                {{ task.planned_date.strftime('%b %d') }}
                                            </span>
                                            <span class="px-2 py-1 bg-white/20 rounded text-xs font-medium">
                                                P{{ task.priority }}
                                            </span>
                                        </div>
                                        <h4 class="font-semibold mb-1">{{ task.task_name or task.topic.topic_name }}</h4>
                                        <p class="text-sm text-orange-100">{{ task.topic.subject.name }} ‚Ä¢ {{ task.goal.goal_name or task.goal.title if task.goal else 'No Goal' }}</p>
                                    </div>
                                    <a href="{{ url_for('main.complete_task', id=task.task_id) }}" 
                                       class="ml-4 px-4 py-2 bg-white text-orange-600 rounded-lg font-medium hover:bg-orange-50 transition-colors flex-shrink-0">
                                        Complete Now
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="mb-8 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl shadow-lg p-6">
        <div class="flex items-center space-x-4">
            <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center">
                    <i class="material-icons text-2xl">check_circle</i>
                </div>
            </div>
            <div>
                <h3 class="text-xl font-bold mb-1">üéâ You're up to the mark, buddy!</h3>
                <p class="text-green-100">No pending tasks. Good going! Keep up the excellent momentum!</p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Analytics Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
        <!-- Progress Overview Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Today's Progress</h3>
                <div class="text-2xl font-bold text-blue-600">
                    {% if today_total > 0 %}
                        {{ "%.0f"|format((today_completed / today_total) * 100) }}%
                    {% else %}
                        0%
                    {% endif %}
                </div>
            </div>
            
            <!-- Progress Circle -->
            <div class="flex justify-center">
                <div class="relative w-32 h-32">
                    <svg class="w-32 h-32 transform -rotate-90" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#E5E7EB" stroke-width="8"/>
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#3B82F6" stroke-width="8" 
                                stroke-linecap="round" stroke-dasharray="283" 
                                stroke-dashoffset="{{ 283 - (283 * (today_completed / today_total if today_total > 0 else 0)) }}"
                                class="transition-all duration-1000 ease-out"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <div class="text-xl font-bold text-gray-900">{{ today_completed }}</div>
                        <div class="text-sm text-gray-500">of {{ today_total }}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Task Statistics Card -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">Task Statistics</h3>
            <div class="space-y-4">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="material-icons text-blue-600">assignment</i>
                    </div>
                    <div class="ml-3">
                        <div class="text-xl font-bold text-gray-900">{{ today_total }}</div>
                        <div class="text-sm text-gray-500">Planned Today</div>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="material-icons text-green-600">check_circle</i>
                    </div>
                    <div class="ml-3">
                        <div class="text-xl font-bold text-gray-900">{{ today_completed }}</div>
                        <div class="text-sm text-gray-500">Completed</div>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="material-icons text-yellow-600">grade</i>
                    </div>
                    <div class="ml-3">
                        <div class="text-xl font-bold text-gray-900">{{ "%.1f"|format(today_score) }}</div>
                        <div class="text-sm text-gray-500">Quality Score</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Weekly Summary Card - Collapsible -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200" x-data="{ showWeekly: false }">
            <button @click="showWeekly = !showWeekly" 
                    class="w-full p-6 flex items-center justify-between hover:bg-gray-50 transition-colors rounded-xl">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="material-icons text-purple-600">date_range</i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900">Weekly Summary</h3>
                </div>
                <i class="material-icons text-gray-400 transition-transform duration-200" :class="showWeekly ? 'rotate-180' : ''">expand_more</i>
            </button>
            
            <div x-show="showWeekly" x-collapse class="px-6 pb-6">
                <div class="grid grid-cols-1 gap-4 pt-2">
                    <div class="text-center p-4 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-gray-900">{{ week_total }}</div>
                        <div class="text-sm text-gray-500">Tasks Planned</div>
                    </div>
                    <div class="text-center p-4 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-gray-900">{{ week_completed }}</div>
                        <div class="text-sm text-gray-500">Completed</div>
                    </div>
                    <div class="text-center p-4 bg-yellow-50 rounded-lg">
                        <div class="text-2xl font-bold text-gray-900">{{ "%.1f"|format(week_score) }}</div>
                        <div class="text-sm text-gray-500">Avg Score</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's Tasks Section -->
    <div class="mb-8">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-gray-900 mb-2">Today's Focus</h2>
            <p class="text-lg text-gray-600">Complete these tasks to maintain your momentum</p>
        </div>

        <!-- Task Statistics Dropdown -->
        {% if today_tasks %}
        <div x-data="{ showStats: false }" class="mb-6">
            <div class="max-w-4xl mx-auto">
                <button @click="showStats = !showStats" 
                        class="w-full bg-white rounded-xl shadow-sm border border-gray-200 p-4 hover:shadow-md transition-all duration-200 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i class="material-icons text-blue-600">analytics</i>
                        </div>
                        <span class="text-lg font-semibold text-gray-900">Task Statistics</span>
                    </div>
                    <i class="material-icons text-gray-400 transition-transform duration-200" :class="showStats ? 'rotate-180' : ''">expand_more</i>
                </button>
                
                <div x-show="showStats" x-collapse class="mt-4 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Total Tasks -->
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="w-12 h-12 mx-auto bg-blue-100 rounded-full flex items-center justify-center mb-3">
                                <i class="material-icons text-blue-600 text-xl">assignment</i>
                            </div>
                            <div class="text-3xl font-bold text-gray-900 mb-1">{{ today_total }}</div>
                            <div class="text-sm font-medium text-gray-600">Total Tasks</div>
                        </div>
                        
                        <!-- Completed Tasks -->
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="w-12 h-12 mx-auto bg-green-100 rounded-full flex items-center justify-center mb-3">
                                <i class="material-icons text-green-600 text-xl">check_circle</i>
                            </div>
                            <div class="text-3xl font-bold text-gray-900 mb-1">{{ today_completed }}</div>
                            <div class="text-sm font-medium text-gray-600">Completed</div>
                        </div>
                        
                        <!-- Pending Tasks -->
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <div class="w-12 h-12 mx-auto bg-orange-100 rounded-full flex items-center justify-center mb-3">
                                <i class="material-icons text-orange-600 text-xl">schedule</i>
                            </div>
                            <div class="text-3xl font-bold text-gray-900 mb-1">{{ today_total - today_completed }}</div>
                            <div class="text-sm font-medium text-gray-600">Pending</div>
                        </div>
                    </div>
                    
                    <!-- Additional Stats -->
                    <div class="mt-6 pt-6 border-t border-gray-200 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">
                                {% set high_priority = today_tasks|selectattr('priority', 'le', 2)|list|length %}
                                {{ high_priority }}
                            </div>
                            <div class="text-xs text-gray-600 mt-1">High Priority</div>
                        </div>
                        
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">
                                {% if today_total > 0 %}
                                    {{ "%.0f"|format((today_completed / today_total) * 100) }}%
                                {% else %}
                                    0%
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-600 mt-1">Completion Rate</div>
                        </div>
                        
                        <div class="text-center">
                            <div class="text-2xl font-bold text-yellow-600">{{ "%.1f"|format(today_score) }}</div>
                            <div class="text-xs text-gray-600 mt-1">Quality Score</div>
                        </div>
                        
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600">
                                {% set total_duration = namespace(value=0) %}
                                {% for task in today_tasks %}
                                    {% if task.planned_duration_min %}
                                        {% set total_duration.value = total_duration.value + task.planned_duration_min %}
                                    {% endif %}
                                {% endfor %}
                                {{ (total_duration.value // 60)|int }}h {{ total_duration.value % 60 }}m
                            </div>
                            <div class="text-xs text-gray-600 mt-1">Planned Time</div>
                        </div>
                    </div>
                    
                    <!-- Priority Breakdown -->
                    <div class="mt-6 pt-6 border-t border-gray-200">
                        <h4 class="text-sm font-semibold text-gray-900 mb-3">Priority Breakdown</h4>
                        <div class="space-y-2">
                            {% for priority in [1, 2, 3, 4, 5] %}
                            {% set p_tasks = today_tasks|selectattr('priority', 'eq', priority)|list %}
                            {% set p_completed = p_tasks|selectattr('is_completed')|list|length %}
                            {% if p_tasks|length > 0 %}
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <span class="px-2 py-1 rounded text-xs font-medium
                                                 {% if priority == 1 %}bg-red-100 text-red-800
                                                 {% elif priority == 2 %}bg-orange-100 text-orange-800
                                                 {% elif priority == 3 %}bg-yellow-100 text-yellow-800
                                                 {% elif priority == 4 %}bg-blue-100 text-blue-800
                                                 {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        P{{ priority }}
                                    </span>
                                    <span class="text-sm text-gray-600">{{ p_completed }}/{{ p_tasks|length }} completed</span>
                                </div>
                                <div class="flex-1 mx-4">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div class="{% if priority == 1 %}bg-red-500{% elif priority == 2 %}bg-orange-500{% elif priority == 3 %}bg-yellow-500{% elif priority == 4 %}bg-blue-500{% else %}bg-gray-500{% endif %} h-2 rounded-full"
                                             style="width: {{ (p_completed / (p_tasks|length)) * 100 if p_tasks|length > 0 else 0 }}%"></div>
                                    </div>
                                </div>
                                <span class="text-sm font-medium text-gray-900">
                                    {{ "%.0f"|format((p_completed / (p_tasks|length)) * 100) if p_tasks|length > 0 else 0 }}%
                                </span>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if today_tasks %}
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                {% for task in today_tasks %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200 
                           {% if task.is_completed %}bg-green-50 border-green-200{% endif %}">
                    <!-- Task Header -->
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            {% if task.is_completed %}
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                    <i class="material-icons text-white text-sm">check</i>
                                </div>
                            {% else %}
                                <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                                    <i class="material-icons text-gray-500 text-sm">radio_button_unchecked</i>
                                </div>
                            {% endif %}
                            
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                         {% if task.priority == 1 %}bg-red-100 text-red-800
                                         {% elif task.priority == 2 %}bg-yellow-100 text-yellow-800
                                         {% else %}bg-blue-100 text-blue-800{% endif %}">
                                P{{ task.priority }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- Task Content -->
                    <div class="space-y-3">
                        <h3 class="text-lg font-semibold text-gray-900">{{ task.topic.topic_name }}</h3>
                        
                        <div class="flex flex-wrap gap-2">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                {{ task.topic.subject.name }}
                            </span>
                            {% if task.goal %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    <i class="material-icons text-xs mr-1">flag</i>
                                    {{ task.goal.goal_name or task.goal.title }}
                                </span>
                            {% endif %}
                        </div>
                        
                        {% if task.notes %}
                        <p class="text-sm text-gray-600 leading-relaxed">{{ task.notes }}</p>
                        {% endif %}
                        
                        <!-- Task Details -->
                        <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                            {% if task.planned_start %}
                            <div class="flex items-center">
                                <i class="material-icons text-sm mr-1">schedule</i>
                                <span>{{ task.planned_start }}</span>
                            </div>
                            {% endif %}
                            
                            {% if task.planned_duration_min %}
                            <div class="flex items-center">
                                <i class="material-icons text-sm mr-1">timer</i>
                                <span>{{ task.planned_duration_min }} min</span>
                            </div>
                            {% endif %}
                            
                            <div class="flex items-center">
                                <i class="material-icons text-sm mr-1">grade</i>
                                <span>{{ "%.1f"|format(task.task_score) }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Task Actions -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        {% if not task.is_completed %}
                            <a href="{{ url_for('main.complete_task', id=task.task_id) }}" 
                               class="inline-flex items-center justify-center w-full px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors">
                                <i class="material-icons text-sm mr-2">check</i>
                                Complete Task
                            </a>
                        {% else %}
                            <div class="flex items-center justify-center text-green-600 font-medium">
                                <i class="material-icons text-sm mr-2">check_circle</i>
                                <span>Completed</span>
                                {% if task.latest_completion and task.latest_completion.enthusiasm_score %}
                                    <span class="ml-2 inline-flex items-center px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">
                                        {{ task.latest_completion.enthusiasm_score }}/10
                                    </span>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-16">
                <div class="w-20 h-20 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-6">
                    <i class="material-icons text-4xl text-gray-400">assignment</i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">No tasks planned for today</h3>
                <p class="text-gray-600 mb-6">Start building momentum by creating your first focused task</p>
                <a href="{{ url_for('main.new_task') }}" 
                   class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="material-icons mr-2">add</i>
                    Create Your First Task
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Active Goals Section -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Active Goals</h2>
            <a href="{{ url_for('main.goals') }}" 
               class="inline-flex items-center px-4 py-2 border border-blue-600 text-blue-600 font-medium rounded-lg hover:bg-blue-50 transition-colors">
                View All Goals
            </a>
        </div>

        {% if active_goals %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for goal in active_goals %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">{{ goal.goal_name or goal.title }}</h3>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            Active
                        </span>
                    </div>
                    
                    {% if goal.description %}
                    <p class="text-gray-600 mb-4">{{ goal.description }}</p>
                    {% endif %}
                    
                    <!-- Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Progress</span>
                            <span class="text-sm font-bold text-blue-600">{{ "%.1f"|format(goal.progress_percentage) }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full transition-all duration-500" 
                                 style="width: {{ goal.progress_percentage }}%"></div>
                        </div>
                    </div>
                    
                    <!-- Goal Details -->
                    <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                        {% if goal.target_date %}
                        <div class="flex items-center">
                            <i class="material-icons text-sm mr-1">event</i>
                            <span>{{ goal.target_date.strftime('%b %d, %Y') }}</span>
                        </div>
                        {% endif %}
                        <div class="flex items-center">
                            <i class="material-icons text-sm mr-1">assignment</i>
                            <span>{{ goal.tasks.count() }} tasks</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-16">
                <div class="w-20 h-20 mx-auto bg-gray-100 rounded-full flex items-center justify-center mb-6">
                    <i class="material-icons text-4xl text-gray-400">flag</i>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">No active goals</h3>
                <p class="text-gray-600 mb-6">Define your first strategic goal to anchor your study mission</p>
                <a href="{{ url_for('main.new_goal') }}" 
                   class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="material-icons mr-2">add</i>
                    Create First Goal
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Recent Activity Stream -->
    {% if recent_completions %}
    <div class="mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Recent Victories</h2>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="divide-y divide-gray-200">
                {% for completion in recent_completions %}
                <div class="p-6 hover:bg-gray-50 transition-colors">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">{{ completion.task.topic.topic_name }}</h3>
                            <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                                <span>{{ completion.task.topic.subject.name }}</span>
                                <span>{{ completion.created_at.strftime('%b %d, %I:%M %p') }}</span>
                                {% if completion.enthusiasm_score %}
                                <span>Enthusiasm: {{ completion.enthusiasm_score }}/10</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if completion.enthusiasm_score %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            {{ completion.enthusiasm_score }}/10
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions Grid -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <a href="{{ url_for('main.new_task') }}" 
           class="group bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md hover:scale-105 transition-all duration-200 text-center">
            <div class="w-12 h-12 mx-auto bg-blue-100 rounded-lg flex items-center justify-center mb-4 group-hover:bg-blue-200 transition-colors">
                <i class="material-icons text-blue-600 text-2xl">add_task</i>
            </div>
            <span class="text-sm font-semibold text-gray-900">Add Task</span>
        </a>
        
        <a href="{{ url_for('main.new_goal') }}" 
           class="group bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md hover:scale-105 transition-all duration-200 text-center">
            <div class="w-12 h-12 mx-auto bg-green-100 rounded-lg flex items-center justify-center mb-4 group-hover:bg-green-200 transition-colors">
                <i class="material-icons text-green-600 text-2xl">flag</i>
            </div>
            <span class="text-sm font-semibold text-gray-900">New Goal</span>
        </a>
        
        <a href="{{ url_for('main.analytics') }}" 
           class="group bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md hover:scale-105 transition-all duration-200 text-center">
            <div class="w-12 h-12 mx-auto bg-purple-100 rounded-lg flex items-center justify-center mb-4 group-hover:bg-purple-200 transition-colors">
                <i class="material-icons text-purple-600 text-2xl">analytics</i>
            </div>
            <span class="text-sm font-semibold text-gray-900">Analytics</span>
        </a>
        
        <a href="{{ url_for('main.topics') }}" 
           class="group bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md hover:scale-105 transition-all duration-200 text-center">
            <div class="w-12 h-12 mx-auto bg-yellow-100 rounded-lg flex items-center justify-center mb-4 group-hover:bg-yellow-200 transition-colors">
                <i class="material-icons text-yellow-600 text-2xl">topic</i>
            </div>
            <span class="text-sm font-semibold text-gray-900">Topics</span>
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Define timeProgress function BEFORE Alpine.js loads
window.timeProgress = function() {
    return {
        currentTime: '00:00:00',
        timePercentage: 0,
        hoursLeft: '0',
        minutesLeft: '0',
        timeStatus: 'üî•',
        urgencyTitle: '',
        urgencyMessage: '',
        motivationalMessage: '',
        
        startClock() {
            this.updateTime();
            // Update every second
            setInterval(() => {
                this.updateTime();
            }, 1000);
        },
        
        updateTime() {
            // 10 Motivational messages that rotate
            const motivationalQuotes = [
                'Every second counts - make them all meaningful! üí™',
                'Time waits for no one. Act NOW! ‚ö°',
                'Your future self will thank you for what you do TODAY! üåü',
                'Champions are made when nobody is watching! üèÜ',
                'The best time to start was yesterday. The next best time is NOW! üöÄ',
                'Success is the sum of small efforts repeated day in and day out! üíØ',
                'Don\'t watch the clock; do what it does. Keep going! ‚è∞',
                'The harder you work, the luckier you get! üçÄ',
                'Dream big, work hard, stay focused! üéØ',
                'Every accomplishment starts with the decision to try! ‚ú®'
            ];
            
            // Get current time - Using local time which should be IST on your system
            const now = new Date();
            
            // Get IST time properly
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            
            // Format time display
            this.currentTime = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // Calculate progress (3 AM = 3:00, 9 PM = 21:00)
            const startHour = 3;
            const endHour = 21;
            const totalMinutes = (endHour - startHour) * 60; // 18 hours = 1080 minutes
            
            // Calculate current minutes from 3 AM
            let currentMinutes = 0;
            if (hours >= startHour && hours < endHour) {
                currentMinutes = (hours - startHour) * 60 + minutes;
            } else if (hours >= endHour) {
                currentMinutes = totalMinutes; // After 9 PM
            }
            // Before 3 AM, currentMinutes stays 0
            
            // Calculate percentage
            this.timePercentage = Math.min(Math.round((currentMinutes / totalMinutes) * 100), 100);
            
            // Calculate time left
            const minutesRemaining = Math.max(0, totalMinutes - currentMinutes);
            this.hoursLeft = Math.floor(minutesRemaining / 60);
            this.minutesLeft = minutesRemaining % 60;
            
            // Rotate motivational message every 10 seconds
            const messageIndex = Math.floor((seconds / 10)) % motivationalQuotes.length;
            
            // Set rotating motivational message
            this.motivationalMessage = motivationalQuotes[messageIndex];
            
            // Set status and messages based on time
            if (hours < startHour) {
                // Before 3 AM - Early bird
                this.timeStatus = 'üåô';
                this.urgencyTitle = 'üåô Night Owl Mode!';
                this.urgencyMessage = 'The world is asleep, but winners are preparing for greatness. Your day starts in ' + (startHour - hours) + ' hours!';
            } else if (hours >= startHour && hours < 6) {
                // 3 AM - 6 AM - Golden hours
                this.timeStatus = 'üåÖ';
                this.urgencyTitle = 'üåÖ GOLDEN MORNING HOURS!';
                this.urgencyMessage = 'The most productive hours! Your mind is fresh, distractions are zero. This is YOUR time to shine!';
            } else if (hours >= 6 && hours < 9) {
                // 6 AM - 9 AM - Peak time
                this.timeStatus = '‚ö°';
                this.urgencyTitle = '‚ö° PEAK PRODUCTIVITY TIME!';
                this.urgencyMessage = 'Your brain is at its sharpest! Attack the hardest tasks NOW. This energy won\'t last forever!';
            } else if (hours >= 9 && hours < 12) {
                // 9 AM - 12 PM - Morning power
                this.timeStatus = 'üî•';
                this.urgencyTitle = 'üî• MORNING POWER HOURS!';
                this.urgencyMessage = 'The morning is still yours! Push harder, focus deeper. Every task you complete now is a victory!';
            } else if (hours >= 12 && hours < 15) {
                // 12 PM - 3 PM - Afternoon grind
                this.timeStatus = 'üí™';
                this.urgencyTitle = 'üí™ AFTERNOON GRIND TIME!';
                this.urgencyMessage = 'Half the day is gone! Don\'t slow down now. Keep the momentum. Your future self will thank you!';
            } else if (hours >= 15 && hours < 18) {
                // 3 PM - 6 PM - Critical hours
                this.timeStatus = '‚ö†Ô∏è';
                this.urgencyTitle = '‚ö†Ô∏è CRITICAL HOURS - PUSH HARDER!';
                this.urgencyMessage = 'Time is slipping away FAST! The clock is ticking. What you do NOW defines your tomorrow!';
            } else if (hours >= 18 && hours < 21) {
                // 6 PM - 9 PM - Final sprint
                this.timeStatus = 'üö®';
                this.urgencyTitle = 'üö® FINAL SPRINT - LAST CHANCE!';
                this.urgencyMessage = 'THESE ARE YOUR LAST HOURS! Give it EVERYTHING you\'ve got! No regrets, only results!';
            } else {
                // After 9 PM
                this.timeStatus = 'üåÉ';
                this.urgencyTitle = 'üåÉ Day Ended - Reflect & Rest';
                this.urgencyMessage = 'The productive day is over. Did you give your best? Rest well, tomorrow is another chance to dominate!';
            }
        }
    }
};

// Log to confirm script loaded
console.log('timeProgress function loaded successfully');
</script>
{% endblock %}

{% block fab %}
<!-- Floating Action Button -->
<a href="{{ url_for('main.new_task') }}" 
   class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg hover:shadow-xl flex items-center justify-center transition-all duration-200 z-50 group">
    <i class="material-icons text-xl group-hover:scale-110 transition-transform">add</i>
</a>
{% endblock %}

