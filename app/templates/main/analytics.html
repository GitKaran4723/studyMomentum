{% extends "base.html" %}

{% block title %}Analytics - Study Momentum{% endblock %}

{% block content %}
<!-- Analytics Hero Section -->
<div class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 text-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="text-center">
            <!-- Badge -->
            <div class="inline-flex items-center px-4 py-2 bg-white/20 backdrop-blur-sm rounded-full text-sm font-medium mb-6">
                <i class="material-icons text-lg mr-2">analytics</i>
                <span>Analytics Dashboard</span>
            </div>
            
            <!-- Title -->
            <h1 class="text-4xl lg:text-5xl font-bold mb-4">
                Insights that drive
                <span class="bg-gradient-to-r from-yellow-300 to-orange-300 bg-clip-text text-transparent">growth.</span>
            </h1>
            <p class="text-lg lg:text-xl text-blue-100 mb-8 max-w-3xl mx-auto">
                Transform your data into actionable insights. Track patterns, identify opportunities, and optimize your path to success with comprehensive performance analytics.
            </p>
            
            <!-- Hero Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-3xl mx-auto">
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
                    <div class="text-3xl font-bold mb-1">{{ analytics_data.get('total_sessions', 0) }}</div>
                    <div class="text-blue-200">Study Sessions</div>
                </div>
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
                    <div class="text-3xl font-bold mb-1">{{ analytics_data.get('total_hours', 0) }}</div>
                    <div class="text-blue-200">Hours Tracked</div>
                </div>
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-6 border border-white/20">
                    <div class="text-3xl font-bold mb-1">{{ analytics_data.get('productivity_score', 0) }}%</div>
                    <div class="text-blue-200">Productivity</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Analytics Content -->
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Time Period Selector -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
        <div class="flex flex-wrap gap-2 justify-center">
            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium tab-btn active" data-period="week">
                This Week
            </button>
            <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors tab-btn" data-period="month">
                This Month
            </button>
            <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors tab-btn" data-period="quarter">
                3 Months
            </button>
            <button class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium hover:bg-gray-200 transition-colors tab-btn" data-period="year">
                This Year
            </button>
        </div>
    </div>

    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Task Completion Rate -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                        <i class="material-icons text-green-600">assignment_turned_in</i>
                    </div>
                    <h3 class="font-semibold text-gray-900">Task Completion</h3>
                </div>
                <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">+5.2%</span>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-2">{{ analytics_data.get('completion_rate', 0) }}%</div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="bg-green-600 h-2 rounded-full transition-all duration-500" style="width: {{ analytics_data.get('completion_rate', 0) }}%"></div>
            </div>
        </div>

        <!-- Focus Time -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="material-icons text-blue-600">schedule</i>
                    </div>
                    <h3 class="font-semibold text-gray-900">Focus Time</h3>
                </div>
                <span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full">+12.1%</span>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-2">{{ analytics_data.get('focus_hours', 0) }}h</div>
            <p class="text-sm text-gray-600">Daily average: {{ (analytics_data.get('focus_hours', 0) / 7)|round(1) }}h</p>
        </div>

        <!-- Streak Days -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i class="material-icons text-orange-600">local_fire_department</i>
                    </div>
                    <h3 class="font-semibold text-gray-900">Current Streak</h3>
                </div>
                <span class="text-xs text-orange-600 bg-orange-100 px-2 py-1 rounded-full">Active</span>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-2">{{ analytics_data.get('current_streak', 0) }}</div>
            <p class="text-sm text-gray-600">days in a row</p>
        </div>

        <!-- Goal Progress -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center space-x-2">
                    <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i class="material-icons text-purple-600">flag</i>
                    </div>
                    <h3 class="font-semibold text-gray-900">Goals Achieved</h3>
                </div>
                <span class="text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded-full">+3</span>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-2">{{ analytics_data.get('completed_goals', 0) }}/{{ analytics_data.get('total_goals', 0) }}</div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                {% set total_goals = analytics_data.get('total_goals', 0) %}
                {% set completed_goals = analytics_data.get('completed_goals', 0) %}
                {% set goal_percentage = ((completed_goals / total_goals * 100)|round) if total_goals > 0 else 0 %}
                <div class="bg-purple-600 h-2 rounded-full transition-all duration-500" 
                     style="width: {{ goal_percentage }}%"></div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Activity Chart -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Daily Activity</h3>
                <div class="flex items-center space-x-2 text-sm text-gray-600">
                    <div class="w-3 h-3 bg-blue-600 rounded-full"></div>
                    <span>Tasks Completed</span>
                </div>
            </div>
            {% if daily_data and daily_data|length > 0 %}
            {% set max_tasks = daily_data|map(attribute='completed_tasks')|max or 1 %}
            <div class="h-64 flex items-end justify-between space-x-2">
                {% for row in daily_data[-7:] %}
                {% set day_name = row.planned_date.strftime('%a') if row.planned_date else 'N/A' %}
                {% set height_percent = ((row.completed_tasks / max_tasks * 180)|round) if row.completed_tasks > 0 else 0 %}
                <div class="flex flex-col items-center flex-1 group relative">
                    <div class="w-full bg-gray-200 rounded-t-lg relative" style="height: 200px;">
                        <div class="absolute bottom-0 w-full bg-blue-600 rounded-t-lg transition-all duration-500 hover:bg-blue-700" 
                             style="height: {{ height_percent }}px;"></div>
                    </div>
                    <span class="text-xs text-gray-600 mt-2">{{ day_name }}</span>
                    <!-- Tooltip -->
                    <div class="absolute bottom-full mb-2 hidden group-hover:block bg-gray-900 text-white text-xs rounded py-1 px-2 whitespace-nowrap">
                        {{ row.completed_tasks }}/{{ row.total_tasks }} tasks
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="h-64 flex items-center justify-center">
                <div class="text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="material-icons text-gray-400 text-3xl">bar_chart</i>
                    </div>
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">No Activity Data</h4>
                    <p class="text-gray-500 text-sm">Complete tasks to see your daily activity</p>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Progress Overview -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">Progress Overview</h3>
            <div class="space-y-6">
                <!-- Study Time Progress -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Study Time Goal</span>
                        <span class="text-sm font-bold text-blue-600">{{ analytics_data.get('weekly_hours', 0) }}/40h</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" 
                             style="width: {{ (analytics_data.get('weekly_hours', 0) / 40 * 100)|round }}%"></div>
                    </div>
                </div>

                <!-- Task Completion Progress -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Weekly Tasks</span>
                        <span class="text-sm font-bold text-green-600">{{ analytics_data.get('weekly_tasks', 0) }}/25</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-green-600 h-3 rounded-full transition-all duration-500" 
                             style="width: {{ (analytics_data.get('weekly_tasks', 0) / 25 * 100)|round }}%"></div>
                    </div>
                </div>

                <!-- Goal Progress -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">Goal Milestones</span>
                        <span class="text-sm font-bold text-purple-600">{{ analytics_data.get('monthly_milestones', 0) }}/10</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="bg-purple-600 h-3 rounded-full transition-all duration-500" 
                             style="width: {{ (analytics_data.get('monthly_milestones', 0) / 10 * 100)|round }}%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Subject Performance -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900">Subject Performance</h3>
            <span class="text-sm text-gray-500">Last 30 days</span>
        </div>
        
        {% if subject_data and subject_data|length > 0 %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% set colors = ['blue', 'green', 'purple', 'orange', 'indigo', 'pink', 'teal', 'rose', 'cyan', 'amber'] %}
            {% for subject in subject_data %}
            {% set completion_rate = ((subject.completed_tasks / subject.total_tasks * 100)|round) if subject.total_tasks > 0 else 0 %}
            {% set color = colors[loop.index0 % colors|length] %}
            <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-900 mb-1">{{ subject.name }}</h4>
                        <div class="flex items-center gap-2">
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-{{ color }}-100 text-{{ color }}-700">
                                {{ completion_rate }}% complete
                            </span>
                        </div>
                    </div>
                    <div class="w-12 h-12 bg-gradient-to-br from-{{ color }}-400 to-{{ color }}-600 rounded-lg flex items-center justify-center flex-shrink-0 shadow-lg">
                        <i class="material-icons text-white text-xl">book</i>
                    </div>
                </div>
                
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                    <div class="bg-gradient-to-r from-{{ color }}-400 to-{{ color }}-600 h-2.5 rounded-full transition-all duration-500" 
                         style="width: {{ completion_rate }}%"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div class="bg-white rounded px-2 py-1.5 text-center">
                        <div class="font-bold text-gray-900">{{ subject.total_tasks }}</div>
                        <div class="text-gray-500">Total Tasks</div>
                    </div>
                    <div class="bg-white rounded px-2 py-1.5 text-center">
                        <div class="font-bold text-{{ color }}-600">{{ subject.completed_tasks }}</div>
                        <div class="text-gray-500">Completed</div>
                    </div>
                </div>
                
                {% if subject.avg_enthusiasm %}
                <div class="mt-2 pt-2 border-t border-gray-200">
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-600">Enthusiasm</span>
                        <div class="flex items-center gap-1">
                            <i class="material-icons text-yellow-500" style="font-size: 14px;">star</i>
                            <span class="font-bold text-gray-900">{{ (subject.avg_enthusiasm)|round(1) }}/10</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="w-16 h-16 bg-gradient-to-br from-gray-100 to-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="material-icons text-gray-400 text-3xl">book</i>
            </div>
            <h4 class="text-lg font-semibold text-gray-900 mb-2">No Subject Data Yet</h4>
            <p class="text-gray-600 mb-4">Complete some tasks to see subject performance analytics</p>
            <a href="{{ url_for('main.tasks') }}" 
               class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-medium rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all duration-200">
                <i class="material-icons text-sm">assignment</i>
                <span>View Tasks</span>
            </a>
        </div>
        {% endif %}
    </div>

    <!-- Quick Stats Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Streak Milestone -->
        <div class="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl p-6 border-2 border-orange-200">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center shadow-lg">
                    <i class="material-icons text-white text-2xl">local_fire_department</i>
                </div>
                <span class="text-xs font-bold text-orange-700 bg-orange-200 px-3 py-1 rounded-full">STREAK</span>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-1">{{ analytics_data.get('current_streak', 0) }} days</div>
            <p class="text-sm text-gray-600">Keep the momentum going!</p>
        </div>

        <!-- Completion Rate -->
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border-2 border-green-200">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center shadow-lg">
                    <i class="material-icons text-white text-2xl">check_circle</i>
                </div>
                <span class="text-xs font-bold text-green-700 bg-green-200 px-3 py-1 rounded-full">SUCCESS</span>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-1">{{ analytics_data.get('completion_rate', 0) }}%</div>
            <p class="text-sm text-gray-600">Task completion rate</p>
        </div>

        <!-- Total Study Time -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border-2 border-blue-200">
            <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-full flex items-center justify-center shadow-lg">
                    <i class="material-icons text-white text-2xl">access_time</i>
                </div>
                <span class="text-xs font-bold text-blue-700 bg-blue-200 px-3 py-1 rounded-full">TIME</span>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-1">{{ analytics_data.get('total_hours', 0) }}h</div>
            <p class="text-sm text-gray-600">Total study hours</p>
        </div>
    </div>
</div>

<!-- Analytics JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-btn');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            tabButtons.forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-700');
            });
            
            this.classList.add('active', 'bg-blue-600', 'text-white');
            this.classList.remove('bg-gray-100', 'text-gray-700');
            
            const period = this.dataset.period;
            updateAnalyticsData(period);
        });
    });
    
    setTimeout(() => {
        const progressBars = document.querySelectorAll('[style*="width:"]');
        progressBars.forEach(bar => {
            const width = bar.style.width;
            bar.style.width = '0%';
            bar.offsetHeight;
            bar.style.width = width;
        });
    }, 500);
});

function updateAnalyticsData(period) {
    const metricsGrid = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4');
    if (metricsGrid) {
        metricsGrid.style.opacity = '0.7';
    }
    
    setTimeout(() => {
        console.log(`Updating analytics for period: ${period}`);
        
        if (metricsGrid) {
            metricsGrid.style.opacity = '1';
        }
        
        showNotification(`Analytics updated for ${period.replace('_', ' ')}`);
    }, 1000);
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 z-50 px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg transform transition-all duration-300 translate-x-full';
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 100);
    
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}